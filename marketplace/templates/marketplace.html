{% extends 'base.html' %}
{% block title %}Marketplace - Basix{% endblock %}
{% block content %}

<script src="https://static.sumsub.com/idensic/static/sumsub-kyc.js"></script>


  <!-- MAIN -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <!-- Title + Subtitle -->
<!-- Marketplace Title Section -->
<section class="relative mb-16 text-center px-4">
  <!-- Title -->
  <h1 class="text-4xl md:text-5xl font-bold text-gray-900 tracking-tight" style="color: darkgreen;">
    Marketplace
  </h1>

  <!-- Subtitle -->
  <p class="mt-4 text-lg md:text-xl text-gray-600 max-w-2xl mx-auto leading-relaxed">
    Discover and invest in 
    <span class="font-semibold text-gray-800">tokenized phigital assets</span> ‚Äî  
    a seamless blend of <span class="font-medium text-gray-700">real estate</span> 
    and <span class="font-medium text-gray-700">digital innovation</span>.
  </p>
</section>



<!-- FILTER BAR -->
<section class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4 mb-6" style="margin-top: -30px;">
  <div class="flex flex-wrap items-center gap-3">
    <!-- Search -->
    <label class="flex-1 min-w-[220px]">
      <div class="relative">
        <input 
          class="w-full h-11 pl-10 pr-3 rounded-lg border border-gray-300 focus:outline-none focus:border-emerald-600 focus:ring-1 focus:ring-emerald-300 placeholder-gray-400 text-sm"
          type="text" 
          placeholder="Search properties..." 
        />
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"/>
        </svg>
      </div>
    </label>

    <!-- Location select -->
    <button class="h-11 px-4 rounded-lg border border-gray-300 bg-white inline-flex items-center gap-2 text-gray-700 hover:border-emerald-400 hover:bg-gray-50 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-300">
      <span>All Locations</span>
      <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="m6 9 6 6 6-6"/>
      </svg>
    </button>

    <!-- Type select -->
    <button class="h-11 px-4 rounded-lg border border-emerald-500/60 bg-white inline-flex items-center gap-2 text-gray-800 hover:border-emerald-600 hover:border-2 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-300">
      <span>All Types</span>
      <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="m6 9 6 6 6-6"/>
      </svg>
    </button>

    <!-- Filter icon -->
    <button class="h-11 w-11 rounded-lg border border-gray-300 hover:bg-gray-50 flex items-center justify-center text-sm focus:outline-none focus:ring-1 focus:ring-emerald-300">
      <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 6h18M6 12h12M9 18h6"/>
      </svg>
    </button>

    <!-- View toggles -->
    <div class="flex items-center gap-2">
      <button id="gridBtn" 
        class="h-11 w-11 rounded-lg flex items-center justify-center font-medium transition 
               bg-emerald-600 text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-1 focus:ring-emerald-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h7v7H4zM13 4h7v7h-7zM4 13h7v7H4zM13 13h7v7h-7z"/>
        </svg>
      </button>
      
      <button id="listBtn" 
        class="h-11 w-11 rounded-lg flex items-center justify-center font-medium transition 
               border border-gray-300 bg-white text-gray-800 hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-emerald-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8 6h12M4 6h.01M8 12h12M4 12h.01M8 18h12M4 18h.01"/>
        </svg>
      </button>
    </div>

    
{% if user.is_authenticated %}
  {% if kyc_verified %}
    <div class="flex flex-col items-center gap-2">
      <button 
          onclick="openAddListingModal()"
          class="px-6 py-3 bg-emerald-600 rounded-2xl shadow-xl hover:bg-emerald-700 hover:shadow-2xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center gap-2">
        <span class="text-xl text-white">‚ûï</span>
        <span class="font-semibold text-white">Add Listing</span>
      </button>
      {% if kyc_status == 'auto_approved' %}
        <div class="flex items-center space-x-1 px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          <span>Auto-Approved</span>
        </div>
        <p class="text-sm text-green-600 text-center max-w-xs font-medium">Verification completed! You can now create listings.</p>
      {% endif %}
    </div>
  {% elif kyc_status == 'pending' %}
    <div class="flex flex-col items-center gap-2">
      <button 
          class="px-6 py-3 bg-yellow-500 rounded-2xl shadow-xl cursor-not-allowed opacity-75 flex items-center justify-center gap-2">
        <svg class="w-5 h-5 text-white animate-spin" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span class="font-semibold text-white">Verification Under Review</span>
      </button>
      <p class="text-sm text-yellow-600 text-center max-w-xs font-medium">Your verification is being reviewed. We'll notify you once approved.</p>
    </div>
  {% elif kyc_status == 'rejected' %}
    <div class="flex flex-col items-center gap-2">
      <button 
          onclick="window.location.href='{% url 'kyc_verification' %}'"
          class="px-6 py-3 bg-red-500 rounded-2xl shadow-xl hover:bg-red-600 hover:shadow-2xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center gap-2">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
        <span class="font-semibold text-white">Resubmit Verification</span>
      </button>
      <p class="text-sm text-red-600 text-center max-w-xs font-medium">Verification was rejected. Please resubmit with correct documents.</p>
    </div>
  {% else %}
    <div class="flex flex-col items-center gap-2">
      <button 
          onclick="window.location.href='{% url 'kyc_verification' %}'"
          class="px-6 py-3 bg-orange-500 rounded-2xl shadow-xl hover:bg-orange-600 hover:shadow-2xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center gap-2">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
        </svg>
        <span class="font-semibold text-white">Complete Verification</span>
      </button>
      <p class="text-sm text-orange-600 text-center max-w-xs font-medium">Complete verification to unlock listing creation and premium features.</p>
    </div>
  {% endif %}
{% else %}
  <button 
      onclick="openModal('loginModal')"
      class="px-6 py-3 bg-gray-500 rounded-2xl shadow-xl hover:bg-gray-600 hover:shadow-2xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center gap-2">
      <span class="text-xl text-white">üîí</span>
      <span class="font-semibold text-white">Login to Add Listing</span>
  </button>
{% endif %}



  </div>

<!-- PROPERTY LISTINGS -->
<section class="mt-8">
  <!-- Results Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">Available Properties</h2>
      <p class="text-gray-600 mt-1">{{ listings|length }} propert{{ listings|length|pluralize:"y,ies" }} found</p>
    </div>
    
    <!-- AI Recommendations Badge -->
    {% if kyc_verified and listings %}
      <div class="flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-emerald-50 to-green-50 rounded-xl border border-emerald-200">
        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
        <span class="text-sm font-medium text-emerald-700">AI-Powered Recommendations</span>
      </div>
    {% endif %}
  </div>

  <!-- Filter Buttons -->
  <div class="flex flex-wrap gap-3 mb-6">
    <button id="filterAll" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition-colors">
      All Properties
    </button>
    {% if user.is_authenticated %}
      <button id="filterMyListings" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition-colors">
        My Listings
      </button>
    {% endif %}
    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
      Residential
    </button>
    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
      Commercial
    </button>
    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
      Under $500K
    </button>
    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
      AI Verified
    </button>
  </div>

  <!-- Property Grid -->
  {% if listings %}
    <div id="propertyGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for listing in listings %}
        {% include 'partials/property_card.html' with listing=listing %}
      {% endfor %}
    </div>
  {% else %}
    <!-- Empty State -->
    <div class="text-center py-16">
      <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-6">
        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
        </svg>
      </div>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">No Properties Available</h3>
      <p class="text-gray-600 mb-6 max-w-md mx-auto">
        There are currently no properties available for viewing. Check back later or create the first listing!
      </p>
      {% if kyc_verified %}
        <button onclick="openAddListingModal()" 
                class="px-6 py-3 bg-emerald-600 text-white font-semibold rounded-xl hover:bg-emerald-700 transition-colors">
          Create First Listing
        </button>
      {% endif %}
    </div>
  {% endif %}
</section>





  <!-- Add Listing Modal -->
<div id="addListingModal" class="fixed inset-0 hidden z-[9999] overflow-y-auto">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

  <!-- Centered container -->
  <div class="relative z-[10000] flex items-center justify-center min-h-full p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 relative">
      <!-- Close button -->
      <button onclick="closeAddListingModal()"
              class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl leading-none">
        &times;
      </button>

      <h2 class="text-2xl font-semibold mb-4" id="modalTitle">Step 1 of 6: Upload Media</h2>

      <!-- Progress bar -->
      <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
        <div id="progressBar" class="bg-emerald-500 h-2 rounded-full w-[20%]"></div>
      </div>

      <form id="listingForm" class="space-y-4" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- ===== Step 1: Media (Enhanced) ===== -->
<div class="step" id="step1">
  <!-- Images -->
  <label class="block text-gray-700 mb-2 font-medium">Property Images *</label>

  <!-- Dropzone -->
  <div id="imagesDropzone"
       class="relative border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-emerald-400 transition-colors cursor-pointer bg-white"
       aria-describedby="imagesHelp" tabindex="0">
    <!-- real input (hidden) -->
    <input id="imagesInput" type="file" name="images" accept="image/*" multiple class="hidden" />

    <div class="flex flex-col items-center justify-center gap-3">
      <div class="w-12 h-12 flex items-center justify-center rounded-full bg-emerald-50">
        <!-- upload icon -->
        <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M12 3v12" />
        </svg>
      </div>

      <div>
        <p class="text-lg font-medium text-gray-900">Upload Property Images</p>
        <p class="text-sm text-gray-500 mt-1">Drag & drop images here, or <button type="button" id="imagesBrowseBtn" class="text-emerald-600 hover:underline font-medium">click to browse</button></p>
        <p class="text-xs text-gray-400 mt-2">JPG, PNG, GIF ‚Äî up to <span id="imgMaxCountLabel">12</span> files ‚Ä¢ max <span id="imgMaxSizeLabel">10MB</span> each</p>
      </div>
    </div>
  </div>

  <!-- Inline errors -->
  <div id="imageErrors" class="mt-3 text-sm text-red-600 hidden" role="alert" aria-live="polite"></div>

  <!-- Thumbnails -->
  <div id="imagePreviewGrid" class="mt-4 grid grid-cols-3 sm:grid-cols-4 gap-3"></div>

  <!-- Small helper -->
  <p class="text-sm text-gray-500 mt-2">Tip: Hold Ctrl / Cmd to select multiple files from your file chooser.</p>

  <!-- Divider -->
  <div class="mt-6 border-t"></div>

  <!-- Video -->
  <label class="block text-gray-700 mb-2 mt-6 font-medium">Property Video (optional)</label>

  <div id="videoDropzone"
       class="relative border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:border-emerald-400 transition-colors cursor-pointer bg-white"
       aria-describedby="videoHelp" tabindex="0">
    <input id="videoInput" type="file" name="video" accept="video/*" class="hidden" />
    <div class="flex flex-col items-center gap-3">
      <div class="w-10 h-10 flex items-center justify-center rounded-full bg-emerald-50">
        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.868v4.264a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>

      <div>
        <p class="text-md font-medium text-gray-900">Upload Property Video</p>
        <p class="text-sm text-gray-500 mt-1">MP4, MOV, AVI ‚Äî max <span id="videoMaxSizeLabel">50MB</span></p>
      </div>
    </div>
  </div>

  <div id="videoError" class="mt-3 text-sm text-red-600 hidden" role="alert" aria-live="polite"></div>

  <!-- Video preview -->
  <div id="videoPreviewWrap" class="mt-4 hidden">
    <div class="bg-gray-50 rounded-lg p-3 flex items-start gap-3">
      <video id="videoPreview" class="w-full max-h-48 rounded-md" controls></video>
      <div class="flex flex-col items-end gap-2">
        <div class="text-sm text-gray-900 font-medium" id="videoFileName"></div>
        <div class="text-xs text-gray-500" id="videoFileSize"></div>
        <button type="button" id="removeVideoBtn" class="mt-2 px-3 py-1 rounded-md bg-red-50 text-red-600 hover:bg-red-100">Remove</button>
      </div>
    </div>
  </div>
</div>
<!-- ===== end enhanced Step 1 ===== -->




<!-- ===== Step 2: Property Details (Polished) ===== -->
<div class="step hidden" id="step2">
  <h3 class="text-xl font-semibold text-gray-800 mb-6">üè° Property Details</h3>

  <!-- Title -->
  <div class="mb-5">
    <label class="block text-gray-700 font-medium mb-1">Title *</label>
    <div class="relative">
      <input type="text" name="title" required
             placeholder="Spacious 3BHK Apartment in Downtown"
             class="w-full border rounded-lg pl-10 pr-3 py-2 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 placeholder-gray-400" />
      <span class="absolute left-3 top-2.5 text-gray-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2 12l9 9 11-11-9-9-11 11z" />
        </svg>
      </span>
    </div>
    <p class="text-xs text-gray-500 mt-1">Catchy headline to grab attention.</p>
  </div>

  <!-- Description -->
  <div class="mb-5">
    <label class="block text-gray-700 font-medium mb-1">Description *</label>
    <textarea name="description" rows="4" required
              placeholder="Describe the property features, amenities, nearby landmarks..."
              class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 placeholder-gray-400"></textarea>
    <p class="text-xs text-gray-500 mt-1">Highlight special features like balconies, views, or facilities.</p>
  </div>

  <!-- Location -->
  <div class="mb-5">
    <label class="block text-gray-700 font-medium mb-1">Location *</label>
    <div class="relative">
      <input type="text" name="location" required
             placeholder="MG Road, Bangalore"
             class="w-full border rounded-lg pl-10 pr-3 py-2 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 placeholder-gray-400" />
      <span class="absolute left-3 top-2.5 text-gray-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 21c-4.418-4.418-7-7.686-7-11a7 7 0 1114 0c0 3.314-2.582 6.582-7 11z" />
          <circle cx="12" cy="10" r="3" />
        </svg>
      </span>
    </div>
    <p class="text-xs text-gray-500 mt-1">Enter address or nearest landmark.</p>
  </div>



  <!-- City -->
<div class="mb-5">
  <label class="block text-gray-700 font-medium mb-1">City *</label>
  <div class="relative">
    <input type="text" name="city" required
           placeholder="Bangalore"
           class="w-full border rounded-lg pl-10 pr-3 py-2 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 placeholder-gray-400" />
    <span class="absolute left-3 top-2.5 text-gray-400">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 12c2.28 0 4-1.72 4-4s-1.72-4-4-4-4 1.72-4 4 1.72 4 4 4z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M2 20c0-4 4-7 10-7s10 3 10 7" />
      </svg>
    </span>
  </div>
</div>

<!-- State -->
<div class="mb-5">
  <label class="block text-gray-700 font-medium mb-1">State *</label>
  <div class="relative">
    <input type="text" name="state" required
           placeholder="Karnataka"
           class="w-full border rounded-lg pl-10 pr-3 py-2 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 placeholder-gray-400" />
    <span class="absolute left-3 top-2.5 text-gray-400">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12h18M3 6h18M3 18h18" />
      </svg>
    </span>
  </div>
</div>

<!-- Country -->
<div class="mb-5">
  <label class="block text-gray-700 font-medium mb-1">Country *</label>
  <div class="relative">
    <input type="text" name="country" required
           placeholder="India"
           value="India"
           class="w-full border rounded-lg pl-10 pr-3 py-2 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 placeholder-gray-400" />
    <span class="absolute left-3 top-2.5 text-gray-400">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 2a10 10 0 100 20 10 10 0 000-20z" />
      </svg>
    </span>
  </div>
</div>




  <!-- Property Type -->
  <div class="mb-5">
    <label class="block text-gray-700 font-medium mb-1">Property Type *</label>
    <select name="property_type" required
            class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 bg-white">
      <option value="">Select Type</option>
      <option value="residential">Residential</option>
      <option value="apartment">Apartment</option>
      <option value="commercial">Commercial</option>
      <option value="land">Land</option>
      <option value="industrial">Industrial</option>
    </select>
  </div>

  <!-- Size + Bedrooms + Bathrooms -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-5">
    <div>
      <label class="block text-gray-700 font-medium mb-1">Size (sq.ft)</label>
      <div class="relative">
        <input type="number" step="0.01" name="size"
               placeholder="1200"
               class="w-full border rounded-lg pl-10 pr-3 py-2 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 placeholder-gray-400" />
        <span class="absolute left-3 top-2.5 text-gray-400">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h18M3 12h18M3 17h18" />
          </svg>
        </span>
      </div>
    </div>
    <div>
      <label class="block text-gray-700 font-medium mb-1">Bedrooms</label>
      <input type="number" name="bedrooms"
             placeholder="3"
             class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 placeholder-gray-400" />
    </div>
    <div>
      <label class="block text-gray-700 font-medium mb-1">Bathrooms</label>
      <input type="number" name="bathrooms"
             placeholder="2"
             class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 placeholder-gray-400" />
    </div>
  </div>

  <!-- Year Built + Ownership Type -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5">
    <div>
      <label class="block text-gray-700 font-medium mb-1">Year Built</label>
      <div class="relative">
        <input type="number" name="year_built"
               placeholder="2015"
               class="w-full border rounded-lg pl-10 pr-3 py-2 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 placeholder-gray-400" />
        <span class="absolute left-3 top-2.5 text-gray-400">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </span>
      </div>
    </div>
    <div>
      <label class="block text-gray-700 font-medium mb-1">Ownership Type</label>
      <input type="text" name="ownership_type"
             placeholder="Freehold / Leasehold"
             class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 placeholder-gray-400" />
    </div>
  </div>
</div>
<!-- ===== end enhanced Step 2 ===== -->






<!-- ===== Step 3: Compliance (Polished) ===== -->
<div class="step hidden" id="step3">
  <h3 class="text-xl font-semibold text-gray-800 mb-6">üìë Compliance Documents</h3>
  <p class="text-sm text-gray-500 mb-6">
    Please upload the required compliance documents. Supported formats: <strong>PDF, JPG, PNG</strong>.
  </p>

  <div class="space-y-6">

    <!-- Title Deed -->
    <div class="border-2 border-dashed rounded-xl p-4 hover:border-emerald-400 transition bg-gray-50">
      <label class="block font-medium text-gray-700 mb-2">Title Deed *</label>
      <div class="flex items-center space-x-3">
        <div class="flex-shrink-0 text-emerald-500">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m2 0a2 2 0 002-2V6a2 2 0 00-2-2H7a2 2 0 00-2 2v4a2 2 0 002 2zm0 0v4a2 2 0 002 2h2a2 2 0 002-2v-4" />
          </svg>
        </div>
        <input type="file" name="title_deed" required accept=".pdf,.jpg,.jpeg,.png"
               class="flex-1 border rounded-lg px-3 py-2 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-emerald-500 file:text-white file:text-sm file:cursor-pointer hover:file:bg-emerald-600" />
      </div>
      <p class="text-xs text-gray-500 mt-2">Upload property title deed (PDF, JPG, PNG)</p>
    </div>

    <!-- Tax Certificate -->
    <div class="border-2 border-dashed rounded-xl p-4 hover:border-emerald-400 transition bg-gray-50">
      <label class="block font-medium text-gray-700 mb-2">Tax Certificate *</label>
      <div class="flex items-center space-x-3">
        <div class="flex-shrink-0 text-emerald-500">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h18M3 12h18M3 17h18" />
          </svg>
        </div>
        <input type="file" name="tax_certificate" required accept=".pdf,.jpg,.jpeg,.png"
               class="flex-1 border rounded-lg px-3 py-2 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-emerald-500 file:text-white file:text-sm file:cursor-pointer hover:file:bg-emerald-600" />
      </div>
      <p class="text-xs text-gray-500 mt-2">Upload latest tax certificate (PDF, JPG, PNG)</p>
    </div>

    <!-- Utility Bills -->
    <div class="border-2 border-dashed rounded-xl p-4 hover:border-emerald-400 transition bg-gray-50">
      <label class="block font-medium text-gray-700 mb-2">Utility Bills *</label>
      <div class="flex items-center space-x-3">
        <div class="flex-shrink-0 text-emerald-500">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-7a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <input type="file" name="utility_bills" required accept=".pdf,.jpg,.jpeg,.png"
               class="flex-1 border rounded-lg px-3 py-2 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-emerald-500 file:text-white file:text-sm file:cursor-pointer hover:file:bg-emerald-600" />
      </div>
      <p class="text-xs text-gray-500 mt-2">Upload recent utility bills (PDF, JPG, PNG)</p>
    </div>

    <!-- KYC Document -->
    <div class="border-2 border-dashed rounded-xl p-4 hover:border-emerald-400 transition bg-gray-50">
      <label class="block font-medium text-gray-700 mb-2">KYC / Identity Document *</label>
      <div class="flex items-center space-x-3">
        <div class="flex-shrink-0 text-emerald-500">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5zm0 7v-7" />
          </svg>
        </div>
        <input type="file" name="kyc_doc" required accept=".pdf,.jpg,.jpeg,.png"
               class="flex-1 border rounded-lg px-3 py-2 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-emerald-500 file:text-white file:text-sm file:cursor-pointer hover:file:bg-emerald-600" />
      </div>
      <p class="text-xs text-gray-500 mt-2">Upload government-issued ID (PDF, JPG, PNG)</p>
    </div>


  </div>
</div>
<!-- ===== end enhanced Step 3 ===== -->







<!-- ===== Step 4: Pricing (Enhanced) ===== -->
<div class="step hidden" id="step4">
  <h3 class="text-xl font-semibold text-gray-800 mb-6">üí∞ Pricing & Options</h3>

  <!-- Asking Price -->
  <div class="mb-5">
    <label class="block text-gray-700 font-medium mb-1">Asking Price ($) *</label>
    <div class="relative">
      <input type="number" step="0.01" name="price" required
             placeholder="Enter your asking price"
             class="w-full border rounded-lg pl-10 pr-3 py-2 focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 placeholder-gray-400" />
      <span class="absolute left-3 top-2.5 text-gray-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-3.314 0-6 1.343-6 3s2.686 3 6 3 6-1.343 6-3-2.686-3-6-3zM12 8v8m0 0c-3.314 0-6-1.343-6-3m6 3c3.314 0 6-1.343 6-3" />
        </svg>
      </span>
    </div>
    <p class="text-xs text-gray-500 mt-1">Set the price for your property listing. You can let an agent suggest a price below.</p>
  </div>

  <!-- Fractionalisation Option -->
  <div class="mb-3">
    <label class="flex items-center space-x-3 cursor-pointer">
      <input type="checkbox" name="fractionalisation" value="true"
             class="w-5 h-5 text-emerald-500 border-gray-300 rounded focus:ring-2 focus:ring-emerald-400">
      <span class="text-gray-700 font-medium">Enable Fractionalisation</span>
    </label>
    <p class="text-xs text-gray-500 ml-7 mt-1">Allow partial ownership of this property.</p>
  </div>

  <!-- Let Agent Suggest Price -->
  <div class="mb-3">
    <label class="flex items-center space-x-3 cursor-pointer">
      <input type="checkbox" name="let_agent_suggest" value="true"
             class="w-5 h-5 text-emerald-500 border-gray-300 rounded focus:ring-2 focus:ring-emerald-400">
      <span class="text-gray-700 font-medium">Let Valuation Agent Suggest Price</span>
    </label>
    <p class="text-xs text-gray-500 ml-7 mt-1">If checked, a professional agent can recommend a price for you.</p>
  </div>
</div>
<!-- ===== end enhanced Step 4 ===== -->





        <!-- Step 5: Wallet Connection -->
        <div class="step hidden" id="step5">
          <div class="text-center">
            <div class="mb-4">
              <svg class="w-16 h-16 mx-auto text-emerald-600 mb-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
              </svg>
              <h3 class="text-lg font-semibold text-gray-900 mb-2">Connect Your Wallet</h3>
              <p class="text-gray-600 mb-4">Connect your wallet to mint NFTs for your property listings.</p>
            </div>
            
            <div id="walletStatus" class="mb-4">
              {% if user.is_authenticated and user.profile.wallet_address %}
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                  <div class="flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="text-green-700 font-medium">Wallet Connected</span>
                  </div>
                  <p class="text-sm text-green-600 mt-1">{{ user.profile.wallet_address|truncatechars:20 }}...</p>
                </div>
              {% else %}
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                  <div class="flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                    <span class="text-yellow-700 font-medium">Wallet Not Connected</span>
                  </div>
                  <p class="text-sm text-yellow-600 mt-1">You can still create listings, but NFTs won't be minted automatically.</p>
                </div>
              {% endif %}
            </div>
            
            <div class="space-y-3">
              <button type="button" onclick="connectWallet()" 
                      class="w-full bg-emerald-600 text-white font-semibold py-3 px-4 rounded-xl hover:bg-emerald-700 transition-colors">
                <div class="flex items-center justify-center space-x-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                  </svg>
                  <span>Connect Wallet</span>
                </div>
              </button>
              
              <button type="button" onclick="updateWalletAddress()" 
                      class="w-full bg-gray-100 text-gray-700 font-semibold py-3 px-4 rounded-xl hover:bg-gray-200 transition-colors">
                <div class="flex items-center justify-center space-x-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                  <span>Update Wallet Address</span>
                </div>
              </button>
            </div>
          </div>
        </div>

        <!-- Step 6: Preview -->
        <div class="step hidden" id="step6">
          <div id="previewContent" class="bg-gray-100 p-3 rounded-lg mb-4 text-sm text-gray-800"></div>
          <div class="form-check">
            <input type="checkbox" name="confirm" required class="mr-2">
            <label>I confirm all information is correct.</label>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between mt-6">
          <button type="button" id="prevBtn"
                  class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 text-gray-800 hidden"
                  onclick="prevStep()">Previous</button>
          <button type="button" id="nextBtn"
                  class="px-4 py-2 bg-emerald-600 rounded-lg hover:bg-emerald-700 text-white"
                  onclick="nextStep()">Next</button>
          <button type="submit" id="submitBtn"
                  class="px-4 py-2 bg-emerald-600 rounded-lg hover:bg-emerald-700 text-white hidden">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
(function () {
  // Config
  const IMG_MAX_FILES = 12;
  const IMG_MAX_BYTES = 10 * 1024 * 1024; // 10 MB
  const VIDEO_MAX_BYTES = 50 * 1024 * 1024; // 50 MB
  const acceptedImageTypes = ['image/jpeg','image/png','image/gif','image/webp','image/jpg'];

  // Elements
  const imagesDropzone = document.getElementById('imagesDropzone');
  const imagesInput = document.getElementById('imagesInput');
  const imagesBrowseBtn = document.getElementById('imagesBrowseBtn');
  const imageErrors = document.getElementById('imageErrors');
  const imagePreviewGrid = document.getElementById('imagePreviewGrid');
  const imgMaxCountLabel = document.getElementById('imgMaxCountLabel');
  const imgMaxSizeLabel = document.getElementById('imgMaxSizeLabel');

  const videoDropzone = document.getElementById('videoDropzone');
  const videoInput = document.getElementById('videoInput');
  const videoPreviewWrap = document.getElementById('videoPreviewWrap');
  const videoPreview = document.getElementById('videoPreview');
  const videoFileName = document.getElementById('videoFileName');
  const videoFileSize = document.getElementById('videoFileSize');
  const removeVideoBtn = document.getElementById('removeVideoBtn');
  const videoError = document.getElementById('videoError');
  const videoMaxSizeLabel = document.getElementById('videoMaxSizeLabel');

  // State
  let imageFiles = []; // array of File objects
  let videoFile = null;
  let objectUrls = []; // track previews to revoke

  // Initialize labels
  imgMaxCountLabel.textContent = IMG_MAX_FILES;
  imgMaxSizeLabel.textContent = (IMG_MAX_BYTES / (1024 * 1024)) + 'MB';
  videoMaxSizeLabel.textContent = (VIDEO_MAX_BYTES / (1024 * 1024)) + 'MB';

  // Helper to show errors
  function showImageError(msg) {
    imageErrors.textContent = msg;
    imageErrors.classList.remove('hidden');
    setTimeout(() => {
      imageErrors.classList.add('hidden');
    }, 6000);
  }
  function showVideoError(msg) {
    videoError.textContent = msg;
    videoError.classList.remove('hidden');
    setTimeout(() => {
      videoError.classList.add('hidden');
    }, 6000);
  }

  // Update hidden input.files using DataTransfer (so form submits real files)
  function updateImagesInputFiles() {
    const dt = new DataTransfer();
    imageFiles.forEach(f => dt.items.add(f));
    imagesInput.files = dt.files;
  }

  function updateVideoInputFile() {
    const dt = new DataTransfer();
    if (videoFile) dt.items.add(videoFile);
    videoInput.files = dt.files;
  }

  // Render thumbnails
  function renderImagePreviews() {
    // clear existing
    imagePreviewGrid.innerHTML = '';
    objectUrls.forEach(u => URL.revokeObjectURL(u));
    objectUrls = [];

    imageFiles.forEach((file, idx) => {
      const url = URL.createObjectURL(file);
      objectUrls.push(url);

      const wrap = document.createElement('div');
      wrap.className = 'relative rounded-md overflow-hidden border bg-white';

      const img = document.createElement('img');
      img.src = url;
      img.alt = file.name;
      img.className = 'object-cover w-full h-28';

      const info = document.createElement('div');
      info.className = 'p-2 text-xs text-gray-700';
      info.innerHTML = `<div class="truncate font-medium">${escapeHtml(file.name)}</div><div class="text-gray-400">${(file.size/1024|0)} KB</div>`;

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'absolute top-2 right-2 bg-white/80 rounded-full p-1 shadow hover:bg-white';
      removeBtn.innerHTML = `
        <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>`;
      removeBtn.addEventListener('click', () => {
        removeImageAtIndex(idx);
      });

      wrap.appendChild(img);
      wrap.appendChild(removeBtn);
      wrap.appendChild(info);
      imagePreviewGrid.appendChild(wrap);
    });

    // Update hidden input
    updateImagesInputFiles();
  }

  function removeImageAtIndex(index) {
    if (index >= 0 && index < imageFiles.length) {
      // revoke URL for that file (we will revoke all when re-render)
      imageFiles.splice(index, 1);
      renderImagePreviews();
    }
  }

  // Validate and add images
  function handleImageFiles(list) {
    const newFiles = Array.from(list || []);
    if (imageFiles.length + newFiles.length > IMG_MAX_FILES) {
      showImageError(`You can upload up to ${IMG_MAX_FILES} images.`);
    }

    let added = 0;
    for (const f of newFiles) {
      if (imageFiles.length >= IMG_MAX_FILES) break;

      if (!acceptedImageTypes.includes(f.type) && !f.type.startsWith('image/')) {
        showImageError(`"${f.name}" is not a supported image type.`);
        continue;
      }
      if (f.size > IMG_MAX_BYTES) {
        showImageError(`"${f.name}" is too large. Max ${IMG_MAX_BYTES/(1024*1024)}MB.`);
        continue;
      }
      imageFiles.push(f);
      added++;
    }

    if (added > 0) renderImagePreviews();
  }

  // Video handling
  function handleVideoFile(file) {
    if (!file) return;

    if (!file.type.startsWith('video/')) {
      showVideoError('Selected file is not a video.');
      return;
    }
    if (file.size > VIDEO_MAX_BYTES) {
      showVideoError(`Video too large. Max ${(VIDEO_MAX_BYTES/(1024*1024))}MB.`);
      return;
    }

    // Replace existing
    videoFile = file;
    updateVideoInputFile();

    // show preview
    const url = URL.createObjectURL(file);
    videoPreview.src = url;
    videoFileName.textContent = file.name;
    videoFileSize.textContent = `${Math.round(file.size/1024)} KB`;
    videoPreviewWrap.classList.remove('hidden');
  }

  function removeVideo() {
    if (videoPreview.src) {
      try { URL.revokeObjectURL(videoPreview.src); } catch (e) {}
    }
    videoFile = null;
    updateVideoInputFile();
    videoPreview.src = '';
    videoFileName.textContent = '';
    videoFileSize.textContent = '';
    videoPreviewWrap.classList.add('hidden');
  }

  // Drag & drop helpers
  function highlight(dropzone) {
    dropzone.classList.add('border-emerald-400', 'bg-emerald-50');
  }
  function unhighlight(dropzone) {
    dropzone.classList.remove('border-emerald-400', 'bg-emerald-50');
  }

  // Escape helper to avoid XSS from file names in previews
  function escapeHtml(str) {
    return (str + '').replace(/[&<>"'`=\/]/g, function (s) {
      return ({
        '&': '&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'": '&#39;', '/': '&#x2F;', '`':'&#x60;', '=':'&#x3D;'
      })[s];
    });
  }

  // Event wiring (images)
  imagesDropzone.addEventListener('click', () => imagesInput.click());
  imagesBrowseBtn.addEventListener('click', () => imagesInput.click());

  imagesDropzone.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter' || ev.key === ' ') {
      ev.preventDefault();
      imagesInput.click();
    }
  });

  imagesInput.addEventListener('change', (e) => {
    handleImageFiles(e.target.files);
    // clear the native input value if you want to allow re-selecting same files later:
    imagesInput.value = '';
  });

  imagesDropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    highlight(imagesDropzone);
  });
  imagesDropzone.addEventListener('dragleave', (e) => {
    unhighlight(imagesDropzone);
  });
  imagesDropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    unhighlight(imagesDropzone);
    if (e.dataTransfer && e.dataTransfer.files) {
      handleImageFiles(e.dataTransfer.files);
    }
  });

  // Video events
  videoDropzone.addEventListener('click', () => videoInput.click());
  videoDropzone.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter' || ev.key === ' ') {
      ev.preventDefault();
      videoInput.click();
    }
  });

  videoInput.addEventListener('change', (e) => {
    if (e.target.files && e.target.files[0]) {
      handleVideoFile(e.target.files[0]);
    }
    // clear native input to allow same-file reselect
    videoInput.value = '';
  });

  videoDropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    highlight(videoDropzone);
  });
  videoDropzone.addEventListener('dragleave', (e) => {
    unhighlight(videoDropzone);
  });
  videoDropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    unhighlight(videoDropzone);
    if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) {
      handleVideoFile(e.dataTransfer.files[0]);
    }
  });

  removeVideoBtn.addEventListener('click', removeVideo);

  // Expose a tiny API on the dropzone element so other scripts can inspect selected files if needed:
  imagesDropzone.getSelectedFiles = () => imageFiles.slice();
  videoDropzone.getSelectedFile = () => videoFile;

  // Clean up object URLs when the window unloads
  window.addEventListener('beforeunload', () => {
    objectUrls.forEach(u => { try { URL.revokeObjectURL(u); } catch (e) {} });
    if (videoPreview && videoPreview.src) { try { URL.revokeObjectURL(videoPreview.src); } catch (e) {} }
  });

  // init: no initial files
})();
</script>

<script>
let currentStep = 1;
const totalSteps = 6;
let listingId = null;


// Show loader overlay
function showLoader() {
  // Prevent adding multiple overlays
  if (document.getElementById('loaderOverlay')) return;

  const loader = document.createElement('div');
  loader.id = 'loaderOverlay';
  loader.innerHTML = `
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-[11000]">
      <div class="bg-white p-6 rounded-lg shadow-lg text-lg font-medium flex items-center gap-3">
        <svg class="animate-spin h-6 w-6 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        Uploading listing... Please wait
      </div>
    </div>`;
  document.body.appendChild(loader);

  // Disable buttons
  document.getElementById('nextBtn').disabled = true;
  document.getElementById('submitBtn').disabled = true;
}

// Hide loader overlay
function hideLoader() {
  const loader = document.getElementById('loaderOverlay');
  if (loader) loader.remove();

  // Re-enable buttons
  document.getElementById('nextBtn').disabled = false;
  document.getElementById('submitBtn').disabled = false;
}



function showStep(step) {
  document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
  document.getElementById(`step${step}`).classList.remove('hidden');

  document.getElementById('prevBtn').classList.toggle('hidden', step === 1);
  document.getElementById('nextBtn').classList.toggle('hidden', step === totalSteps);
  document.getElementById('submitBtn').classList.toggle('hidden', step !== totalSteps);

  document.getElementById('progressBar').style.width = `${(step / totalSteps) * 100}%`;
  document.getElementById('modalTitle').innerText = `Step ${step} of ${totalSteps}`;

  if (step === 5) generatePreview();
}

async function saveStep(step) {
  const formData = new FormData();
  if (listingId) formData.append('listing_id', listingId);

  const stepDiv = document.getElementById(`step${step}`);
  stepDiv.querySelectorAll('input, select, textarea').forEach(input => {
    if (input.type === 'file') {
      Array.from(input.files).forEach(file => formData.append(input.name, file));
    } else if ((input.type === 'checkbox' && input.checked) || input.type !== 'checkbox') {
      formData.append(input.name, input.value);
    }
  });

  try {
    const res = await fetch(`/save_listing_step/${step}/`, {
      method: 'POST',
      body: formData,
      headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
    });
    const data = await res.json();
    if (data.success && data.listing_id) {
      listingId = data.listing_id;
      return true;
    } else {
      alert(data.error || 'Error saving step');
      return false;
    }
  } catch (err) {
    console.error(err);
    alert('An unexpected error occurred while saving step.');
    return false;
  }
}

async function nextStep() {
  const saved = await saveStep(currentStep);
  if (saved && currentStep < totalSteps) {
    currentStep++;
    showStep(currentStep);
  }
}

function prevStep() {
  if (currentStep > 1) {
    currentStep--;
    showStep(currentStep);
  }
}

function generatePreview() {
  const previewDiv = document.getElementById("previewContent");
  previewDiv.innerHTML = `
    <h3 class="text-lg font-semibold mb-2">Property Preview</h3>
    <p><strong>Title:</strong> ${document.querySelector('[name="title"]').value}</p>
    <p><strong>Description:</strong> ${document.querySelector('[name="description"]').value}</p>
    <p><strong>Location:</strong> ${document.querySelector('[name="location"]').value}</p>
    <p><strong>Type:</strong> ${document.querySelector('[name="property_type"]').value}</p>
    <p><strong>Size:</strong> ${document.querySelector('[name="size"]').value}</p>
    <p><strong>Bedrooms:</strong> ${document.querySelector('[name="bedrooms"]').value}</p>
    <p><strong>Year Built:</strong> ${document.querySelector('[name="year_built"]').value}</p>
    <p><strong>Ownership:</strong> ${document.querySelector('[name="ownership_type"]').value}</p>
    <p><strong>Asking Price:</strong> ‚Çπ${document.querySelector('[name="price"]').value}</p>
    <p><strong>Fractionalisation:</strong> ${document.querySelector('[name="fractionalisation"]').checked ? "Yes" : "No"}</p>
    <p><strong>Let Agent Suggest Price:</strong> ${document.querySelector('[name="let_agent_suggest"]').checked ? "Yes" : "No"}</p>
  `;
}

// Submit Step 5
document.getElementById('listingForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  if (currentStep !== totalSteps) return;

  // Instead of a blocking loader, show a quick toast and proceed
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    const color = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-emerald-600');
    toast.className = `fixed top-4 right-4 ${color} text-white px-4 py-2 rounded-lg shadow-lg z-[12000]`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  showToast('Submitting your property‚Ä¶');

  const formData = new FormData(this);
  if (listingId) formData.append('listing_id', listingId);

  try {
    const res = await fetch('/submit_listing/', {
      method: 'POST',
      body: formData,
      headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
    });
    const data = await res.json();

    if (data.success) {
      showToast('Your property is under review', 'success');
      closeAddListingModal();
      // Soft refresh to show it under "My Listings" with Under Review
      setTimeout(() => window.location.reload(), 1200);
    } else {
      // Handle validation errors by showing them on the appropriate form step
      if (data.validation_errors) {
        showValidationErrors(data.validation_errors);
      } else {
        alert('Error submitting listing: ' + (data.error || 'Unknown error'));
      }
    }
  } catch (err) {
    console.error(err);
    showToast('Failed to submit listing', 'error');
  }
});

function showValidationErrors(errors) {
  // Clear previous errors
  document.querySelectorAll('.field-error').forEach(el => el.remove());
  
  // Map validation errors to form steps
  const errorMapping = {
    'Property title too short': { step: 2, field: 'title' },
    'Property description too short': { step: 2, field: 'description' },
    'Property location too vague': { step: 2, field: 'location' },
    'All 4 documents required': { step: 3, field: 'documents' },
    'All property information required': { step: 2, field: 'basic_info' },
    'Property details incomplete': { step: 2, field: 'property_details' }
  };
  
  // Find the first error and navigate to that step
  let targetStep = 2; // Default to step 2 (basic info)
  let targetField = null;
  
  for (const error of errors) {
    if (errorMapping[error]) {
      targetStep = errorMapping[error].step;
      targetField = errorMapping[error].field;
      break;
    }
  }
  
  // Navigate to the step with errors
  currentStep = targetStep;
  showStep(currentStep);
  
  // Show error messages
  const stepElement = document.getElementById(`step${targetStep}`);
  if (stepElement) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'field-error bg-red-50 border border-red-200 rounded-lg p-3 mb-4';
    errorDiv.innerHTML = `
      <div class="flex items-center">
        <svg class="w-5 h-5 text-red-500 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <div>
          <h4 class="text-red-800 font-semibold">Please fix the following issues:</h4>
          <ul class="text-red-700 text-sm mt-1">
            ${errors.map(error => `<li>‚Ä¢ ${error}</li>`).join('')}
          </ul>
        </div>
      </div>
    `;
    stepElement.insertBefore(errorDiv, stepElement.firstChild);
  }
}

function openAddListingModal() {
  // Check KYC status before opening modal
  {% if user.is_authenticated %}
    {% if kyc_status == 'pending' %}
      alert('Your verification is currently under review. Please wait for approval before creating listings.');
      return;
    {% elif kyc_status == 'rejected' %}
      alert('Your verification was rejected. Please resubmit your documents.');
      window.location.href = '{% url "kyc_verification" %}';
      return;
    {% elif not kyc_verified %}
      alert('Please complete verification before creating a listing.');
      window.location.href = '{% url "kyc_verification" %}';
      return;
    {% endif %}
  {% else %}
    alert('Please login to create a listing.');
    return;
  {% endif %}
  
  document.getElementById("addListingModal").classList.remove("hidden");
  document.body.classList.add("overflow-hidden");
}

function closeAddListingModal() {
  document.getElementById("addListingModal").classList.add("hidden");
  document.body.classList.remove("overflow-hidden");
}

// Property interaction functions
function viewPropertyDetails(listingId) {
  // TODO: Implement detailed property view modal or redirect to detail page
  console.log(`Viewing details for property ${listingId}`);
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const propertyCards = document.querySelectorAll('#propertyGrid > div');
  
  propertyCards.forEach(card => {
    const title = card.querySelector('h3').textContent.toLowerCase();
    const location = card.querySelector('.text-gray-600').textContent.toLowerCase();
    
    if (title.includes(searchTerm) || location.includes(searchTerm)) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
});

// Filter functionality (placeholder)
document.getElementById('locationFilter').addEventListener('click', function() {
  alert('Location filter will be implemented soon!');
});

document.getElementById('typeFilter').addEventListener('click', function() {
  alert('Property type filter will be implemented soon!');
});

document.getElementById('priceFilter').addEventListener('click', function() {
  alert('Price range filter will be implemented soon!');
});

document.getElementById('sortFilter').addEventListener('click', function() {
  alert('Sort options will be implemented soon!');
});

showStep(currentStep);

// Wallet connection functions
function connectWallet() {
  // Mock wallet connection for now
  const walletAddress = prompt("Enter your wallet address:");
  if (walletAddress) {
    updateWalletAddressInProfile(walletAddress);
  }
}

function updateWalletAddress() {
  const walletAddress = prompt("Enter your wallet address:");
  if (walletAddress) {
    updateWalletAddressInProfile(walletAddress);
  }
}

function updateWalletAddressInProfile(walletAddress) {
  fetch('/update-wallet-address/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({
      wallet_address: walletAddress
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the wallet status display
      const walletStatus = document.getElementById('walletStatus');
      walletStatus.innerHTML = `
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <div class="flex items-center justify-center space-x-2">
            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span class="text-green-700 font-medium">Wallet Connected</span>
          </div>
          <p class="text-sm text-green-600 mt-1">${walletAddress.substring(0, 20)}...</p>
        </div>
      `;
    } else {
      alert('Failed to update wallet address: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to update wallet address');
  });
}
</script>






</section>


  </main>

  <!-- JS for toggles -->
  <script>
    const gridBtn = document.getElementById('gridBtn');
    const listBtn = document.getElementById('listBtn');
    const gridView = document.getElementById('gridView');
    const listView = document.getElementById('listView');


function setActive(view) {
  if (view === 'grid') {
    gridBtn.className = "h-11 w-11 rounded-lg flex items-center justify-center transition bg-emerald-700 text-white shadow-sm hover:bg-emerald-800 focus:outline-none focus:ring-1 focus:ring-emerald-300";
    listBtn.className = "h-11 w-11 rounded-lg flex items-center justify-center transition border border-gray-300 bg-white text-gray-800 hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-emerald-300";
    gridView.classList.remove("hidden");
    listView.classList.add("hidden");
  } else {
    listBtn.className = "h-11 w-11 rounded-lg flex items-center justify-center transition bg-emerald-700 text-white shadow-sm hover:bg-emerald-800 focus:outline-none focus:ring-1 focus:ring-emerald-300";
    gridBtn.className = "h-11 w-11 rounded-lg flex items-center justify-center transition border border-gray-300 bg-white text-gray-800 hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-emerald-300";
    listView.classList.remove("hidden");
    gridView.classList.add("hidden");
  }
}

    gridBtn.addEventListener('click', () => setActive('grid'));
    listBtn.addEventListener('click', () => setActive('list'));
    setActive('grid');
  </script>

  <!-- Filter functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const filterAllBtn = document.getElementById('filterAll');
      const filterMyListingsBtn = document.getElementById('filterMyListings');
      const propertyGrid = document.getElementById('propertyGrid');
      
      if (filterAllBtn) {
        filterAllBtn.addEventListener('click', function() {
          // Reset all buttons
          document.querySelectorAll('[id^="filter"]').forEach(btn => {
            btn.className = 'px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors';
          });
          
          // Highlight active button
          filterAllBtn.className = 'px-4 py-2 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition-colors';
          
          // Show only public properties (minted/sold)
          if (propertyGrid) {
            const allCards = propertyGrid.querySelectorAll('.property-card');
            allCards.forEach(card => {
              const isOwner = card.dataset.owner === 'true';
              const hasTokenId = card.dataset.tokenId && card.dataset.tokenId !== '';
              const isSold = card.dataset.status === 'sold';
              
              // Show if it's a public property (minted or sold) OR if it's the owner's property
              if ((hasTokenId || isSold) || isOwner) {
                card.style.display = 'block';
              } else {
                card.style.display = 'none';
              }
            });
          }
        });
      }
      
      if (filterMyListingsBtn) {
        filterMyListingsBtn.addEventListener('click', function() {
          // Reset all buttons
          document.querySelectorAll('[id^="filter"]').forEach(btn => {
            btn.className = 'px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors';
          });
          
          // Highlight active button
          filterMyListingsBtn.className = 'px-4 py-2 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition-colors';
          
          // Show only user's listings
          if (propertyGrid) {
            const allCards = propertyGrid.querySelectorAll('.property-card');
            allCards.forEach(card => {
              const isOwner = card.dataset.owner === 'true';
              card.style.display = isOwner ? 'block' : 'none';
            });
          }
        });
      }
    });
  </script>

{% endblock %}